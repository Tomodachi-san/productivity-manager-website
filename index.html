<!DOCTYPE HTML>
<html>
<head>
    <title>Website Test</title>
    <link rel="stylesheet" href="style.css"> 
    <link rel="icon" type="image/x-icon" href="./Logo_Transparent.jpg">
</head>

<body>
    <div class="header">
        <img id="logo" src="Logo.png">
        <h2 id="website_title">orkflow</h2>
        <p id="objective">Organize Tasks and Get Shit Done</p>
    </div>

    <div class="project_details">
        <p id="project_name_paragraph"><span id="project_name" role="textbox" contenteditable></span></p>
        <button id="create_new_task_box_button">Add a New Task List</button>
        <button onclick="save()">Save</button>
        <button onclick="load()">Load</button>
    </div>

    <!-- Collection of Task Boxes -->
    <div id="task_boxes"></div>

    <p class="footer">&#169; Copyright Tomodachi 2023</p>

    <script>
        document.addEventListener("keydown", e => {
            if(e.ctrlKey && e.key === "s"){
                e.preventDefault();
                save();
                console.log("Saved");
            }
        })

        // Save Test Feature
        function save(){
            sessionStorage.setItem("document", document.body.innerHTML);
        }
        function load(){
            document.body.innerHTML = sessionStorage.getItem("document");
            addListeners();
        }
        

        // Global Variables
        let label_one = "Test1";
        let label_two = "Test2";
        let label_three = "Test3";
        let label_four = "Test4";
        let label_five = "Test5";
        let label_six = "Test6";

        let toggleLabelBool = false;


        if(navigator.userAgentData.mobile){
            if(window.innerHeight > window.innerWidth){
                alert("Portrait");
            } else alert("Landscape");
        }

        //document.getElementById("rearrange_button").addEventListener("click", test);

        function allowDrop(ev){
            ev.preventDefault();
        }

        var original_pos;
        var original_source;
        function drag(ev){
            original_source = event.target.id.replace(/[0-9]/g, '');

            if(original_source === "task_box_"){
                ev.dataTransfer.setData("text", event.target.id);
            } else if(original_source === "sub_box_"){
                ev.dataTransfer.setData("text", event.target.id);
            }
        }

        // Note the difference between the methods of drag and drop, wherein in drop .children is used in combo with getElementById
        // Meanwhile in drag, getElementsByClassName is used. This might break if task box is not the only object in task_boxes.

        function test(){
            let wrapper = document.getElementById("task_boxes").children;
            let xCoords = [0];

            let bodyRect = document.body.getBoundingClientRect().left;

            for(let i = 0; i < wrapper.length; i++){
                let xPos = wrapper[i].getBoundingClientRect().right - bodyRect;
                xCoords.push(xPos);
            }

            let string = "The order of the elements is:";
            for(let i = 0; i < xCoords.length; i++){
                string = string.concat(" ", xCoords[i], ",");
            }
            string = string.concat(" .");

            alert(string);
        }

        let xCoords = [];
        function updatePositions(){
            xCoords.length = 0;
            xCoords.push(0);

            let wrapper = document.getElementById("task_boxes").children;
            

            let bodyRect = document.body.getBoundingClientRect().left;

            let prev_num = 0;
            for(let i = 0; i < wrapper.length; i++){
                let xPos = (wrapper[i].getBoundingClientRect().right - bodyRect);
                let xPos_half = Math.round((xPos - prev_num)/2);
                xCoords.push(xPos_half + prev_num);
                xCoords.push(xPos);
                
                prev_num = xPos;
            }
        }

        updatePositions();

        let order = [];
        function updateOrder(){
            order.length = 0;

            let items = document.getElementById("task_boxes").children;

            for(let i = 0; i < items.length; i++){
                order.push(items[i].id.replace(/\D/g,''));
            }

            let string = "The order of the elements is:";
            for(let i = 0; i < order.length; i++){
                string = string.concat(" ", order[i], ",");
            }
            string = string.concat(" .");

            //alert(string)
        }

        updateOrder();

        let yCoords = [];

        
        function drop(ev){
            if(original_source === "task_box_"){
                let wrapper = document.getElementById("task_boxes");
                let items = wrapper.children;

                for(let i = 0; (i + 1) < xCoords.length; i++){
                    if(event.pageX > xCoords[i] && event.pageX < xCoords[i + 1] && (i + 1) % 2 != 0){
                        //alert("odd");
                        let data = ev.dataTransfer.getData("text");
                        wrapper.insertBefore(document.getElementById(data), items[i]);
                        //console.log(items[i]);
                        addListeners();

                        updatePositions();
                        updateOrder();
                    }
                }
            }
            
            if(original_source === "sub_box_"){
                for(let i = 0; (i + 1) * 2 < xCoords.length; i++){
                    if(event.clientX > xCoords[(i*2)] && event.clientX < xCoords[(i + 1)*2]){
                        //console.log(order[i]);

                        var wrapper = document.getElementById(`task_box_${(order[i])}`).children[1];
                        var items = wrapper.children;
                        var elements = document.createDocumentFragment();

                        yCoords.length = 0;
                        yCoords.push(0);

                        let bodyRect = document.body.getBoundingClientRect().top;
                        
                        for(let i = 0; i < items.length; i++){
                            let yPos = Math.round(items[i].getBoundingClientRect().bottom - bodyRect);
                            yCoords.push(yPos);
                        }

                        //yCoords.push(document.getElementById(`task_box_${(order[i] + 1)}`).getBoundingClientRect().bottom - bodyRect);
                        
                        let string = "The order of the elements is:";
                        for(let i = 0; i < yCoords.length; i++){
                            string = string.concat(" ", yCoords[i], ",");
                        }
                        string = string.concat(" .");

                        //alert(yCoords);
                        
                        if(yCoords.length === 1){
                            let data = ev.dataTransfer.getData("text");
                            wrapper.appendChild(document.getElementById(data));
                            addListeners();
                        } else {
                            for(let i = 1; i < yCoords.length; i++){
                                if(event.clientY > yCoords[i - 1] && event.clientY < yCoords[i] && (i) != (yCoords.length)){
                                    let data = ev.dataTransfer.getData("text");
                                    wrapper.insertBefore(document.getElementById(data), items[i]);
                                    addListeners();
                                }

                                if(event.clientY > yCoords[i - 1] && event.clientY < yCoords[i] && (i) === (yCoords.length)){
                                    let data = ev.dataTransfer.getData("text");
                                    wrapper.insertBefore(document.getElementById(data), items[i].nextSibling);
                                    addListeners();
                                }
                            }
                        }
                    }
                }

                let string = "The order of the elements is:";
                for(let i = 0; i < yCoords.length; i++){
                    string = string.concat(" ", yCoords[i], ",");
                }
                string = string.concat(" .");

                //alert(string);
            }
                

            //alert(event.clientX);
            
        }

        function rearrange(){
            let wrapper = document.getElementById("task_boxes");
            let items = wrapper.children;
            let elements = document.createDocumentFragment();

            let order = [];

            for(let i = 0; i < items.length; i++){
                order.push(i);
            }

            let temp_num;

            for(let i = 0; i < items.length; i++){
                if(i === 0){
                    temp_num = order[i];
                    order[i] = order[i + 1];
                }
                else if(i === items.length - 1) order[i] = temp_num;
                else order[i] = order[i + 1];
            }

            order.forEach(function(idx){
                elements.appendChild(items[idx].cloneNode(true));
            });

            wrapper.innerHTML = null;
            wrapper.appendChild(elements);
            addListeners();
        }

        let counter = 1;
        let counter_sub_box = 1;

        // General Listeners such as when not currently in a description modal.
        function addListeners(){
            document.getElementById("create_new_task_box_button").addEventListener("click", addTaskBox);
            for(let i = 0; i < document.getElementsByClassName("task_box").length; i++){
                try {
                    document.getElementById(`add_sub_box_button_${i + 1}`).addEventListener("click", addSubBox);
                } catch(error) {
                    console.log("Missing Sub Box Index LOL");
                }
            }
                
            for(let i = 0; i < document.getElementsByClassName("sub_box").length; i++){
                document.getElementById(`description_button_${i + 1}`).addEventListener("click", showDescription);
                document.getElementById(`description_close_button_${i + 1}`).addEventListener("click", () => {
                    document.getElementById(`sub_box_description_${i + 1}`).style.display = "none";
                });
            }
        }

        addListeners();
        
        function addTaskBox(){
            let new_task_box = document.createElement("div");

            // Apply CSS styles by making them part of Classes
            new_task_box.classList.add("task_box");

            new_task_box.setAttribute("id", `task_box_${counter}`);
            new_task_box.setAttribute("draggable", "true");
            new_task_box.setAttribute("ondrop", "drop(event)");
            new_task_box.setAttribute("ondragover", "allowDrop(event)");
            new_task_box.setAttribute("ondragstart", "drag(event)");

            let new_task_box_initial_text = document.createElement("input");

            // Apply CSS styles by making them part of Classes
            new_task_box_initial_text.classList.add("box_title");

            new_task_box_initial_text.setAttribute("placeholder", "Task List Name");
            new_task_box_initial_text.setAttribute("autocomplete", "off");
            new_task_box_initial_text.setAttribute("type", "text");
            new_task_box_initial_text.setAttribute("maxlength", "22");
            new_task_box_initial_text.setAttribute("size", "22");
            

            new_task_box.appendChild(new_task_box_initial_text);

            // Append new collection of sub boxes on the new task box
            let new_sub_box_collection = document.createElement("div");
            new_sub_box_collection.classList.add("sub_box_collection")
            new_task_box.appendChild(new_sub_box_collection);

            // Append Create Sub Box Button On the bottom of the new task box
            let new_sub_box_button = document.createElement("button");

            let new_sub_box_button_textnode = document.createTextNode("Add a New Subtask...");
            new_sub_box_button.appendChild(new_sub_box_button_textnode)

            new_sub_box_button.setAttribute("id", `add_sub_box_button_${counter}`);
            new_sub_box_button.classList.add("add_sub_box_button")

            new_task_box.appendChild(new_sub_box_button);

            document.getElementById("task_boxes").append(new_task_box);

            // Add event listener for the add sub box button embedded within this new task box
            document.getElementById(`add_sub_box_button_${counter}`).addEventListener("click", addSubBox);
            counter += 1;

            updatePositions();
            updateOrder();
        }

        addTaskBox();
        document.getElementById("task_boxes").children[0].children[0].value = "TO DO";

        addTaskBox();
        document.getElementById("task_boxes").children[1].children[0].value = "DOING";

        addTaskBox();
        document.getElementById("task_boxes").children[2].children[0].value = "DONE";

        //document.getElementById("task_boxes").children[0].remove();



        function addSubBox(event){
            let initial_sub_box = document.createElement("div");

            // Apply CSS styles by making them part of Classes
            initial_sub_box.classList.add("sub_box");

            // Label Unit
            let initial_label_unit = document.createElement("div");

            let initial_label_one_container = document.createElement("div");
            initial_label_one_container.setAttribute("onclick", "toggleLabels()");
            initial_label_one_container.setAttribute("id", `sub_box_${counter_sub_box}_label_one_front`);
            initial_label_one_container.classList.add("label_one_container")
            let initial_label_one_text = document.createElement("p");
            initial_label_one_text.classList.add("label_text");
            let initial_label_one_text_textnode = document.createTextNode(`${label_one}`);
            initial_label_one_text.appendChild(initial_label_one_text_textnode);

            initial_label_one_container.appendChild(initial_label_one_text);


            let initial_label_two_container = document.createElement("div");
            initial_label_two_container.setAttribute("onclick", "toggleLabels()");
            initial_label_two_container.setAttribute("id", `sub_box_${counter_sub_box}_label_two_front`);
            initial_label_two_container.classList.add("label_two_container")
            let initial_label_two_text = document.createElement("p");
            initial_label_two_text.classList.add("label_text");
            let initial_label_two_text_textnode = document.createTextNode(`${label_two}`);
            initial_label_two_text.appendChild(initial_label_two_text_textnode);

            initial_label_two_container.appendChild(initial_label_two_text);


            initial_label_unit.appendChild(initial_label_one_container);
            initial_label_unit.appendChild(initial_label_two_container);

            

            

            initial_sub_box.appendChild(initial_label_unit);
            

            let sub_box_initial_title_outer_paragraph = document.createElement("p");
            let sub_box_initial_title = document.createElement("span");
            sub_box_initial_title_outer_paragraph.classList.add("sub_box_title_paragraph");
            sub_box_initial_title.classList.add("sub_box_title");
            sub_box_initial_title.setAttribute("role", "textbox");
            //new_description.setAttribute("placeholder", "Add Description...");
            sub_box_initial_title.setAttribute("contenteditable", "");

            sub_box_initial_title_outer_paragraph.appendChild(sub_box_initial_title);
            initial_sub_box.appendChild(sub_box_initial_title_outer_paragraph);

            let new_description_unit = document.createElement("div");
            new_description_unit.classList.add("description_unit")

            let new_description_button = document.createElement("button");
            new_description_button.classList.add("description_button")

            let new_description_image = document.createElement("img");
            new_description_image.setAttribute("id", `description_button_${counter_sub_box}`);
            new_description_image.setAttribute("src", "Description.png");
            new_description_image.setAttribute("style", "border-radius: 4px;");

            new_description_button.appendChild(new_description_image);

            new_description_unit.appendChild(new_description_button);


            let new_description = document.createElement("div");
            new_description.classList.add("sub_box_description")
            new_description.setAttribute("id", `sub_box_description_${counter_sub_box}`);

            let new_description_content = document.createElement("div");
            new_description_content.classList.add("sub_box_description_content");


            let new_description_title_image = document.createElement("img");
            new_description_title_image.setAttribute("src", "Description_Title.png");

            let sub_box_description_title = document.createElement("p");
            sub_box_description_title.classList.add("sub_box_description_title");
            let sub_box_description_title_textnode = document.createTextNode("(Subtask Title)");
            sub_box_description_title.appendChild(sub_box_description_title_textnode);

            let task_box_title = event.target.closest(".task_box").children[0].value;
            if(task_box_title == null) task_box_title = "No Task Box Title";

            let sub_box_description_subtitle = document.createElement("p");
            sub_box_description_subtitle.classList.add("sub_box_description_subtitle");
            let sub_box_description_subtitle_textnode = document.createTextNode(`in ${task_box_title}`);
            sub_box_description_subtitle.appendChild(sub_box_description_subtitle_textnode);

            // Labels, Due Dates and maybe in the future add Members
            // Additional Description Division = Labels, Due dates and possibly Members
            let new_additional_description_division = document.createElement("div");

            // Labels
            let new_labels_division = document.createElement("div");
            new_labels_division.setAttribute("id", `labels_division_${counter_sub_box}`);

            let new_labels_collection = document.createElement("div");
            new_labels_collection.setAttribute("id", `labels_collection_${counter_sub_box}`);

            new_labels_division.appendChild(new_labels_collection);

            new_additional_description_division.appendChild(new_labels_division);


            



            // Description
            let new_description_division = document.createElement("div");
            new_description_division.setAttribute("style", "margin: 0px 0px 20px 0px;")

            let sub_box_description_header = document.createElement("p");
            sub_box_description_header.classList.add("sub_box_description_header");
            let sub_box_description_header_textnode = document.createTextNode(`Description`);
            sub_box_description_header.appendChild(sub_box_description_header_textnode);

            let new_description_outer_paragraph = document.createElement("p");
            let new_description_paragraph = document.createElement("span");
            new_description_outer_paragraph.classList.add("sub_box_description_outer_paragraph");
            new_description_paragraph.classList.add("sub_box_description_paragraph");
            new_description_paragraph.setAttribute("role", "textbox");
            new_description_paragraph.setAttribute("contenteditable", "");
            new_description_outer_paragraph.appendChild(new_description_paragraph);

            new_description_division.appendChild(sub_box_description_header);
            new_description_division.appendChild(new_description_outer_paragraph);

            // Footnotes
            let new_footnote_division = document.createElement("div");
            
            let new_description_footnote_image = document.createElement("img");
            new_description_footnote_image.setAttribute("src", "Footnote.png");
            new_description_footnote_image.classList.add("sub_box_footnote_image");

            let sub_box_footnote_header = document.createElement("p");
            sub_box_footnote_header.classList.add("sub_box_footnote_header");
            let sub_box_footnote_header_textnode = document.createTextNode(`Footnotes`);
            sub_box_footnote_header.appendChild(sub_box_footnote_header_textnode);

            let new_footnote_collection = document.createElement("div");
            new_footnote_collection.setAttribute("id", `footnote_collection_${counter_sub_box}`);

            let new_description_add_footnote_button = document.createElement("button");
            new_description_add_footnote_button.setAttribute("id", `footnote_button_${counter_sub_box}`);
            new_description_add_footnote_button.classList.add("sub_box_add_footnote_button");
            let new_description_add_footnote_button_textnode = document.createTextNode("Add Footnote");
            new_description_add_footnote_button.appendChild(new_description_add_footnote_button_textnode);

            new_footnote_division.appendChild(new_description_footnote_image);
            new_footnote_division.appendChild(sub_box_footnote_header);
            new_footnote_division.appendChild(new_footnote_collection);
            new_footnote_division.appendChild(new_description_add_footnote_button);

            
            new_description_content.appendChild(new_description_title_image);
            new_description_content.appendChild(sub_box_description_title);
            new_description_content.appendChild(sub_box_description_subtitle);
            new_description_content.appendChild(new_additional_description_division);
            new_description_content.appendChild(new_description_division);
            new_description_content.appendChild(new_footnote_division)



            let new_description_sidebar = document.createElement("div");
            new_description_sidebar.classList.add("sub_box_description_sidebar");


            let new_description_sidebar_add_buttons = document.createElement("div");
            new_description_sidebar_add_buttons.classList.add("sub_box_description_sidebar_add_buttons");


            let new_description_close_button = document.createElement("span");
            new_description_close_button.classList.add("sub_box_description_close_button");
            new_description_close_button.setAttribute("id", `description_close_button_${counter_sub_box}`);
            let new_description_close_button_textnode = document.createTextNode('\u00D7');
            new_description_close_button.appendChild(new_description_close_button_textnode);

            let new_description_add_text = document.createElement("p");
            new_description_add_text.classList.add("sub_box_description_add_text");
            let new_description_add_text_textnode = document.createTextNode("Add");
            new_description_add_text.appendChild(new_description_add_text_textnode);

            let new_description_add_labels_button = document.createElement("button");
            new_description_add_labels_button.classList.add("sub_box_description_add_labels_button");
            new_description_add_labels_button.setAttribute("id", `description_add_labels_button_${counter_sub_box}`);
            let new_description_add_labels_button_textnode = document.createTextNode("Labels");
            new_description_add_labels_button.appendChild(new_description_add_labels_button_textnode);

            let new_description_add_checklist_button = document.createElement("button");
            new_description_add_checklist_button.classList.add("sub_box_description_add_checklist_button");
            new_description_add_checklist_button.setAttribute("id", `description_add_checklist_button_${counter_sub_box}`);
            let new_description_add_checklist_button_textnode = document.createTextNode("Checklist");
            new_description_add_checklist_button.appendChild(new_description_add_checklist_button_textnode);

            let new_description_add_dates_button = document.createElement("button");
            new_description_add_dates_button.classList.add("sub_box_description_add_dates_button");
            new_description_add_dates_button.setAttribute("id", `description_add_dates_button_${counter_sub_box}`);
            let new_description_add_dates_button_textnode = document.createTextNode("Dates");
            new_description_add_dates_button.appendChild(new_description_add_dates_button_textnode);

            let new_description_add_attachments_button = document.createElement("button");
            new_description_add_attachments_button.classList.add("sub_box_description_add_attachments_button");
            new_description_add_attachments_button.setAttribute("id", `description_add_attachments_button_${counter_sub_box}`);
            let new_description_add_attachments_button_textnode = document.createTextNode("Attachments");
            new_description_add_attachments_button.appendChild(new_description_add_attachments_button_textnode);

            new_description_sidebar_add_buttons.appendChild(new_description_add_text);
            new_description_sidebar_add_buttons.appendChild(new_description_add_labels_button);
            new_description_sidebar_add_buttons.appendChild(new_description_add_checklist_button);
            new_description_sidebar_add_buttons.appendChild(new_description_add_dates_button);
            new_description_sidebar_add_buttons.appendChild(new_description_add_attachments_button);



            let new_description_sidebar_add_buttons_popups = document.createElement("div");
            new_description_sidebar_add_buttons_popups.classList.add("sub_box_sidebar_popups");


            let new_description_label_popup = document.createElement("div");
            new_description_label_popup.classList.add("sub_box_label_popup");
            new_description_label_popup.setAttribute("id", `description_label_popup_${counter_sub_box}`);

            let new_description_label_text = document.createElement("p");
            new_description_label_text.classList.add("sub_box_label_text");
            new_description_label_text.setAttribute("style", "margin: 0px 0px 10px 3px;")
            let new_description_label_text_textnode = document.createTextNode("Labels");
            new_description_label_text.appendChild(new_description_label_text_textnode);

            let new_description_label_close_button = document.createElement("span");
            new_description_label_close_button.classList.add("sub_box_description_label_close_button");
            new_description_label_close_button.setAttribute("id", `description_label_close_button_${counter_sub_box}`);
            let new_description_label_close_button_textnode = document.createTextNode('\u00D7');
            new_description_label_close_button.appendChild(new_description_label_close_button_textnode);

            // Labels

            let new_description_label_one = document.createElement("div");
            new_description_label_one.classList.add("sub_box_label_one");

            let new_description_label_one_container = document.createElement("label");
            new_description_label_one_container.classList.add("sub_box_label_container");

            let new_description_label_one_checklist_box = document.createElement("input");
            new_description_label_one_checklist_box.classList.add("sub_box_description_label_checklist_box");
            new_description_label_one_checklist_box.setAttribute("id", `description_label_one_checklist_box_${counter_sub_box}`);
            new_description_label_one_checklist_box.setAttribute("type", "checkbox");

            let new_description_label_one_checklist_checkmark = document.createElement("span");
            new_description_label_one_checklist_checkmark.classList.add("sub_box_description_label_checklist_checkmark");

            let new_description_label_one_input = document.createElement("input");
            new_description_label_one_input.classList.add("sub_box_label_input");

            new_description_label_one_input.setAttribute("autocomplete", "off");
            new_description_label_one_input.setAttribute("type", "text");
            new_description_label_one_input.setAttribute("maxlength", "15");
            new_description_label_one_input.setAttribute("size", "15");
            new_description_label_one_input.setAttribute("id", `sub_box_${counter_sub_box}_label_one`);
            new_description_label_one_input.setAttribute("value", `${label_one}`);

            new_description_label_one_container.appendChild(new_description_label_one_checklist_box);
            new_description_label_one_container.appendChild(new_description_label_one_checklist_checkmark);
            new_description_label_one_container.appendChild(new_description_label_one_input);

            new_description_label_one.appendChild(new_description_label_one_container);



            let new_description_label_two = document.createElement("div");
            new_description_label_two.classList.add("sub_box_label_two");

            let new_description_label_two_container = document.createElement("label");
            new_description_label_two_container.classList.add("sub_box_label_container");

            let new_description_label_two_checklist_box = document.createElement("input");
            new_description_label_two_checklist_box.classList.add("sub_box_description_label_checklist_box");
            new_description_label_two_checklist_box.setAttribute("id", `description_label_two_checklist_box_${counter_sub_box}`);
            new_description_label_two_checklist_box.setAttribute("type", "checkbox");

            let new_description_label_two_checklist_checkmark = document.createElement("span");
            new_description_label_two_checklist_checkmark.classList.add("sub_box_description_label_checklist_checkmark");

            let new_description_label_two_input = document.createElement("input");
            new_description_label_two_input.classList.add("sub_box_label_input");

            new_description_label_two_input.setAttribute("autocomplete", "off");
            new_description_label_two_input.setAttribute("type", "text");
            new_description_label_two_input.setAttribute("maxlength", "15");
            new_description_label_two_input.setAttribute("size", "15");
            new_description_label_two_input.setAttribute("id", `sub_box_${counter_sub_box}_label_two`);
            new_description_label_two_input.setAttribute("value", `${label_two}`);

            new_description_label_two_container.appendChild(new_description_label_two_checklist_box);
            new_description_label_two_container.appendChild(new_description_label_two_checklist_checkmark);
            new_description_label_two_container.appendChild(new_description_label_two_input);

            new_description_label_two.appendChild(new_description_label_two_container);
            
            


            new_description_label_popup.appendChild(new_description_label_text);
            new_description_label_popup.appendChild(new_description_label_close_button);
            new_description_label_popup.appendChild(new_description_label_one);
            new_description_label_popup.appendChild(new_description_label_two);


            new_description_sidebar_add_buttons_popups.appendChild(new_description_label_popup);
            

            new_description_sidebar.appendChild(new_description_close_button);
            new_description_sidebar.appendChild(new_description_sidebar_add_buttons);
            new_description_sidebar.appendChild(new_description_sidebar_add_buttons_popups);
            
            new_description.appendChild(new_description_content);
            new_description.appendChild(new_description_sidebar);

            initial_sub_box.appendChild(new_description);



            initial_sub_box.appendChild(new_description_unit);

            initial_sub_box.setAttribute("id", `sub_box_${counter_sub_box}`);
            initial_sub_box.setAttribute("draggable", "true");
            initial_sub_box.setAttribute("ondrop", "drop(event)");
            initial_sub_box.setAttribute("ondragover", "allowDrop(event)");
            initial_sub_box.setAttribute("ondragstart", "drag(event)");
            
            event.target.parentElement.children[1].append(initial_sub_box);

            // Automatically closes the labels when others are already closed
            if(toggleLabelBool == true){
                let prev_width = initial_label_one_text.clientWidth + "px";
                initial_label_one_text.style.display = "none";
                initial_label_one_text.parentElement.style.width = prev_width;

                prev_width = initial_label_two_text.clientWidth + "px";
                initial_label_two_text.style.display = "none";
                initial_label_two_text.parentElement.style.width = prev_width;
            }

            initial_label_one_container.style.display = "none";
            initial_label_two_container.style.display = "none";
                


            document.getElementById(`description_button_${counter_sub_box}`).addEventListener("click", showDescription);
            document.getElementById(`description_close_button_${counter_sub_box}`).addEventListener("click", () => {
                document.getElementById(`sub_box_description_${counter_sub_box - 1}`).style.display = "none";
            });
            document.getElementById(`footnote_button_${counter_sub_box}`).addEventListener("click", addFootnote);
            document.getElementById(`description_add_labels_button_${counter_sub_box}`).addEventListener("click", showLabels);

            counter_sub_box += 1;
        }

        function showLabels(event){
            let sub_box_id = event.target.id.replace(/\D/g,'');

            document.getElementById(`sub_box_${sub_box_id}_label_one`).value = label_one;
            
            document.getElementById(`description_label_popup_${sub_box_id}`).style.display = "block";

            // Enable Label Checkbox Functionality
            document.getElementById(`description_label_one_checklist_box_${sub_box_id}`).addEventListener("click", () => {
                if(document.getElementById(`description_label_one_checklist_box_${sub_box_id}`).checked === true){
                    document.getElementById(`sub_box_${sub_box_id}_label_one_front`).style.display = "inline-block";
                } else if(document.getElementById(`description_label_one_checklist_box_${sub_box_id}`).checked === false){
                    document.getElementById(`sub_box_${sub_box_id}_label_one_front`).style.display = "none";
                }
            });
            document.getElementById(`description_label_two_checklist_box_${sub_box_id}`).addEventListener("click", () => {
                if(document.getElementById(`description_label_two_checklist_box_${sub_box_id}`).checked === true){
                    document.getElementById(`sub_box_${sub_box_id}_label_two_front`).style.display = "inline-block";
                } else if(document.getElementById(`description_label_two_checklist_box_${sub_box_id}`).checked === false){
                    document.getElementById(`sub_box_${sub_box_id}_label_two_front`).style.display = "none";
                }
            });

            document.getElementById(`description_label_close_button_${sub_box_id}`).addEventListener("click", closeLabels);
        }

        function closeLabels(event){
            let sub_box_id = event.target.id.replace(/\D/g,'');

            // Update the titles
            if(label_one != document.getElementById(`sub_box_${sub_box_id}_label_one`).value){
                label_one = document.getElementById(`sub_box_${sub_box_id}_label_one`).value;

                for(let i = 1; i < counter_sub_box; i++){
                    document.getElementById(`sub_box_${i}_label_one_front`).innerHTML = label_one;
                }
            }

            if(label_two != document.getElementById(`sub_box_${sub_box_id}_label_two`).value){
                label_two = document.getElementById(`sub_box_${sub_box_id}_label_two`).value;

                for(let i = 1; i < counter_sub_box; i++){
                    document.getElementById(`sub_box_${i}_label_two_front`).innerHTML = label_two;
                }
            }
            
            

            document.getElementById(`description_label_popup_${sub_box_id}`).style.display = "none";
        }

        function addFootnote(event){
            let counter_footnote = document.getElementById(`footnote_collection_${event.target.id.replace(/\D/g,'')}`).children.length + 1;

            let sub_box_id = event.target.id.replace(/\D/g,'');
            let new_footnote = document.createElement("div");
            new_footnote.classList.add("sub_box_footnote");
            new_footnote.setAttribute("id", `sub_box_${sub_box_id}_footnote_${counter_footnote}`);
            new_footnote.setAttribute("style", "margin: 0px 0px 10px 0px;")

            let new_footnote_text = document.createElement("div");
            new_footnote_text.classList.add("sub_box_footnote_text");

            let sub_box_footnote_counter = document.createElement("p");
            sub_box_footnote_counter.classList.add("sub_box_footnote_counter");
            let sub_box_footnote_counter_textnode = document.createTextNode(`${counter_footnote}.`);
            sub_box_footnote_counter.appendChild(sub_box_footnote_counter_textnode);

            let sub_box_footnote_outer_paragraph = document.createElement("p");
            let sub_box_footnote = document.createElement("span");
            sub_box_footnote_outer_paragraph.classList.add("sub_box_footnote_outer_paragraph");
            sub_box_footnote.classList.add("sub_box_footnote");
            sub_box_footnote.setAttribute("role", "textbox");
            //new_description.setAttribute("placeholder", "Add Description...");
            sub_box_footnote.setAttribute("contenteditable", "");
            sub_box_footnote_outer_paragraph.appendChild(sub_box_footnote);

            new_footnote_text.appendChild(sub_box_footnote_counter);
            new_footnote_text.appendChild(sub_box_footnote_outer_paragraph);


            let new_footnote_actions = document.createElement("div");
            new_footnote_actions.classList.add("sub_box_footnote_actions");

            let new_footnote_delete_button = document.createElement("span");
            new_footnote_delete_button.classList.add("sub_box_footnote_delete_button");
            new_footnote_delete_button.setAttribute("id", `sub_box_${sub_box_id}_footnote_delete_button_${counter_footnote}`);
            let new_footnote_delete_button_textnode = document.createTextNode('\u00D7');
            new_footnote_delete_button.appendChild(new_footnote_delete_button_textnode);

            new_footnote_actions.appendChild(new_footnote_delete_button);

            new_footnote.appendChild(new_footnote_text);
            new_footnote.appendChild(new_footnote_actions);

            event.target.parentElement.children[2].appendChild(new_footnote);

            document.getElementById(`sub_box_${sub_box_id}_footnote_delete_button_${counter_footnote}`).addEventListener("click", deleteFootnote);
        }

        function deleteFootnote(event){
            console.log(`${event.target.parentElement.parentElement.parentElement.id}`);

            let collection = event.target.parentElement.parentElement.parentElement;
            let items = collection.children;
            let sub_box_id = event.target.parentElement.parentElement.parentElement.id.replace(/\D/g,'');

            document.getElementById(`${event.target.parentElement.parentElement.id}`).remove();

            if(items.length != 0){
                for(let i = 0; i < items.length; i++){
                    // Set ID Attribute to proper value
                    collection.children[i].setAttribute("id", `sub_box_${sub_box_id}_footnote_${(i + 1)}`);
                    collection.children[i].children[1].children[0].setAttribute("id", `sub_box_${sub_box_id}_footnote_delete_button_${(i + 1)}`);

                    // Change Paragraph
                    collection.children[i].children[0].children[0].innerHTML = `${(i + 1)}.`;
                }
            }
        }

        function showDescription(event){
            preventDragging();

            // Update Sub Box Title
            let updated_sub_box_title = event.target.closest(".sub_box").children[1].children[0].textContent;
            if(updated_sub_box_title === "") updated_sub_box_title = "No Subtask Name";
            event.target.closest(".sub_box").children[2].children[0].children[1].innerHTML = updated_sub_box_title;

            // Update Task Box Title
            let updated_task_box_title = event.target.closest(".task_box").children[0].value;
            if(updated_task_box_title === "") updated_task_box_title = "No Task List Name";
            event.target.closest(".sub_box").children[2].children[0].children[2].innerHTML = " in " + updated_task_box_title;

            let sub_box_description_id = event.target.id.replace(/\D/g,'');
            let sub_box_description = document.getElementById(`sub_box_description_${sub_box_description_id}`);
            sub_box_description.style.display = "flex";

            // Event Listeners for Buttons to Close
            document.getElementById(`description_close_button_${sub_box_description_id}`).addEventListener("click", () => {
                sub_box_description.style.display = "none";
                document.getElementById(`description_label_popup_${sub_box_description_id}`).style.display = "none";
                
                closeLabels(event);
                allowDragging();
            });

            window.addEventListener("click", (event) => {
                if(event.target == sub_box_description){
                    sub_box_description.style.display = "none";
                    document.getElementById(`description_label_popup_${sub_box_description_id}`).style.display = "none";

                    closeLabels(event);
                    allowDragging();
                }
            });
        }

        function toggleLabels(){
            if(toggleLabelBool == false){
                for(let i = 0; i < document.getElementsByClassName("label_text").length; i++){
                    let prev_width = document.getElementsByClassName("label_text")[i].clientWidth + "px";
                    document.getElementsByClassName("label_text")[i].style.display = "none";
                    document.getElementsByClassName("label_text")[i].parentElement.style.width = prev_width;
                }
                
                
                toggleLabelBool = true;

            } else if(toggleLabelBool == true){
                for(let i = 0; i < document.getElementsByClassName("label_text").length; i++){
                    document.getElementsByClassName("label_text")[i].style.display = "inline-block";
                }

                toggleLabelBool = false;
            }
        }

        function preventDragging(){
            for(let i = 0; i < document.getElementsByClassName("task_box").length; i++){
                document.getElementsByClassName("task_box")[i].setAttribute("draggable", "false");
            }

            for(let i = 0; i < document.getElementsByClassName("sub_box").length; i++){
                document.getElementsByClassName("sub_box")[i].setAttribute("draggable", "false");
            }
        }

        function allowDragging(){
            for(let i = 0; i < document.getElementsByClassName("task_box").length; i++){
                document.getElementsByClassName("task_box")[i].setAttribute("draggable", "true");
            }

            for(let i = 0; i < document.getElementsByClassName("sub_box").length; i++){
                document.getElementsByClassName("sub_box")[i].setAttribute("draggable", "true");
            }
        }
    </script>

    
</body>
</html>